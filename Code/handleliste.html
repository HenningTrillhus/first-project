<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="handlelisteStyle.css">
</head> 
<body>
    <div id="menuBoxTop">
        <button onclick="location.href='index.html'">
            Gå til kjøleskap
        </button>
        <button onclick="location.href='savedhandleliste.html'">
            Gå til handleliste arkiv
        </button>
    </div>



    <div id="addGrocerieDiv">
        <div class="add-panel">
            <div class="grocerie-group">
                <input id="grocerie" type="text" pattern="[A-Za-z ]+" name="grocerie" placeholder="Enter grocerie">
                <button type="button" id="importanceToggle" class="importance-toggle" aria-pressed="false" title="Mark as important" onclick="importenseToggold()">
                    <svg viewBox="0 0 24 24" class="importance-icon" aria-hidden="true" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                    </svg>
                </button>
            </div>
            <div class="unit-controls">
                <label for="massurmentChoiceForGroceries">
                    <select name="massurment" id="massurmentChoiceForGroceries">
                        <option value="stk">Stk</option>
                        <option value="Gram">Gram</option>
                        <option value="Kilogram">Kilogram</option>
                        <option value="Liter">Liter</option>
                        <option value="Milliliter">Milliliter</option>
                    </select>
                </label>
                <input id="quantity" type="text" inputmode="decimal" step="any" name="quantity" placeholder="Enter quantity (e.g., 1,5)">

                <label for="categoryChoiceForGroceries">
                    <select name="category" id="categoryChoiceForGroceries">
                        <option value="Annet">Annet</option>
                        <option value="Frukt og grønt">Frukt og grønt</option>
                        <option value="Kjøtt og fisk">Kjøtt og fisk</option>
                        <option value="Meieri">Meieri</option>
                        <option value="Drikke">Drikke</option>
                        <option value="Bakevarer">Bakevarer</option>
                        <option value="Frostvarer">Frostvarer</option>
                        <option value="Husholdning">Husholdning</option>
                        <option value="Helse & vellvære">Helse & vellvære</option>
                        <option value="Kos">Kos</option>
                    </select>
                </label>
            </div>
            <button id="addGroceriesButton">
                Legg til grocerie
            </button>
        </div>
    </div>

    <script> 
        function capitalizeFirstLetter(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        const grocerieListItemsNames = [];

        // Category color map stored in localStorage so user's choices persist
        const defaultCategoryColors = {
            'Annet': 'rgb(255,255,255)',
            'Frukt og grønt': 'rgb(231,249,231)',
            'Kjøtt og fisk': 'rgb(255,236,236)',
            'Meieri': 'rgb(255,247,217)',
            'Drikke': 'rgb(231,245,255)',
            'Bakevarer': 'rgb(255,241,224)',
            'Frostvarer': 'rgb(238,247,255)',
            'Husholdning': 'rgb(247,247,251)',
            'Helse & vellvære': 'rgb(255,176,197)',
            'Kos': 'rgb(255,240,247)'
        };
        let categoryColors = loadCategoryColors();

        function loadCategoryColors(){
            try{
                const stored = localStorage.getItem('categoryColors');
                if (stored) return Object.assign({}, defaultCategoryColors, JSON.parse(stored));
            }catch(e){ /* ignore */ }
            return Object.assign({}, defaultCategoryColors);
        }
        function saveCategoryColors(){
            try{ localStorage.setItem('categoryColors', JSON.stringify(categoryColors)); }catch(e){}
        }
        function getCategoryColor(cat){ return categoryColors[cat] || '#ffffff'; }

        // update color input when category changes
        const categorySelectEl = document.getElementById('categoryChoiceForGroceries');
        const categoryColorEl = document.getElementById('categoryColor');
        if (categorySelectEl && categoryColorEl){
            // initialize color input
            categoryColorEl.value = getCategoryColor(categorySelectEl.value);
            categorySelectEl.addEventListener('change', () => {
                categoryColorEl.value = getCategoryColor(categorySelectEl.value);
            });
            // when the user picks a color, save it for that category
            categoryColorEl.addEventListener('input', () => {
                categoryColors[categorySelectEl.value] = categoryColorEl.value;
                saveCategoryColors();
            });
        }

        document.getElementById('addGroceriesButton').addEventListener('click', addGroceris);

        let active = false;
        function importenseToggold() {
            const importanceToggleBtn = document.getElementById('importanceToggle');
            active = importanceToggleBtn.classList.toggle('active');
            importanceToggleBtn.setAttribute('aria-pressed', active ? 'true' : 'false');
            console.log('Importance toggled:', active);
        }

        // Importance/priority toggle button in the add form (star button)
        /*const importanceToggleBtn = document.getElementById('importanceToggle');
        console.log(importanceToggleBtn);
        if (importanceToggleBtn) {
            importanceToggleBtn.addEventListener('click', function () {
                const active = this.classList.toggle('active');
                this.setAttribute('aria-pressed', active ? 'true' : 'false');
            });
        }*/

        document.getElementById("quantity").addEventListener("input", function () {
            // Allow digits and one decimal separator (comma or dot). Keep the first separator entered and remove any extra separators.
            let val = this.value.replace(/[^0-9.,]/g, "");
            const firstSepMatch = val.match(/[.,]/);
            if (firstSepMatch) {
                const sep = firstSepMatch[0];
                const parts = val.split(/[.,]/);
                val = parts.shift() + sep + parts.join('');
            }
            this.value = val;
        });

        (async function init() {
            try {
                const res = await fetch('/api/grocerieList');
                const json = await res.json();
                if (json.grocerieList && Array.isArray(json.grocerieList)) {
                    renderGroceries(json.grocerieList);
                    json.grocerieList.forEach(i => grocerieListItemsNames.push(i.name));
                }
                console.log('Initial ingredients loaded:', json.grocerieList);
            } catch (e) {
                console.warn('Could not load initial ingredients', e);
            }
        })();

        async function addGroceris() {
            // Get values from input fields, remove whitespace
            let name = document.getElementById('grocerie').value.trim();
            const qtyStr = document.getElementById('quantity').value.trim();
            const massurment = document.getElementById('massurmentChoiceForGroceries').value;
            const category = document.getElementById('categoryChoiceForGroceries').value;
            const completed = false;
            const importance = active;
            console.log('Importance value on add:', importance, 'with the value of active being:', active);
            // persist the currently selected color for this category
            try {
                const chosen = document.getElementById('categoryColor').value;
                if (chosen) { categoryColors[category] = chosen; saveCategoryColors(); }
            } catch(e) {}
            // Capitalize first letter of name
            name = capitalizeFirstLetter(name);

            //Checks for empty fields
            if (name === "" || qtyStr === "") { alert('Please enter name and quantity'); return; }

            // Normalize comma to dot so parseFloat works with both '1.5' and '1,5', then convert to float
            const qty = parseFloat(qtyStr.replace(',', '.'));
            if (Number.isNaN(qty) || qty <= 0) { alert('Please enter a valid quantity greater than 0'); return; }

            // Determine importance from the star toggle (0 = not important, 1 = important)
            //const importens = (document.getElementById('importanceToggle') && document.getElementById('importanceToggle').classList.contains('active')) ? 1 : 0;

            // Send POST request to backend
            const res = await fetch('/api/grocerieList', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, quantity: qty , massurment, completed, category, importance })
            });
            const json = await res.json();

            // If server returns the full list, re-render it and update names index
            if (json.grocerieList && Array.isArray(json.grocerieList)) {
                renderGroceries(json.grocerieList);
                grocerieListItemsNames.length = 0;
                json.grocerieList.forEach(i => grocerieListItemsNames.push(i.name));
                // Reset form importance toggle
                const importanceToggleBtn = document.getElementById('importanceToggle');
                active = false;
                if (importanceToggleBtn) { importanceToggleBtn.classList.remove('active'); importanceToggleBtn.setAttribute('aria-pressed','false'); }
                return;
            }
            // Fallback for older response shape (single ingredient)
            if (grocerieListItemsNames.includes(name)) {
                // Update quantity locally if needed
                json.grocerieList.quantity += qty;
                //printIngredient(json.groscerie);
                console.log(json.grocerieList)
                return;
            } else {
                // Add ingredient name to list of existing ingredients if not existing already
                grocerieListItemsNames.push(name);
            }

            try {
                //renderGroceries(json.groscerie);
            } catch (e) {
                alert('Failed to add groscerie');
            }
            console.log('Penis', json.grocerieList);
            renderGroceries(json.grocerieList);
        }

        // Function to render the full groceries list
        function renderGroceries(grocerieList) {
            const ul = document.getElementById('groceriesUl');
            if (!ul) return; // nothing to render into
            // Clear existing list
            ul.innerHTML = '';
            // Sort by category (then by name) so items are grouped by category
            const sorted = grocerieList.slice().sort((a, b) => {
                //1. category (a-z)
                const ca = (a.category || '').toLowerCase();
                const cb = (b.category || '').toLowerCase();

                if (ca < cb) return -1;
                if (ca > cb) return 1;

                //2. importence at the top
                const ia = a.importance ? 1 : 0;
                const ib = b.importance ? 1 : 0;

                if (ia !== ib) return ib - ia;


                //3. name (a-z)
                const na = (a.name || '').toLowerCase();
                const nb = (b.name || '').toLowerCase();
                if (na < nb) return -1;
                if (na > nb) return 1;
                return 0;
            });
            // Add each grocerie as a list item, grouping by category with headers
            let currentCategory = null;
            sorted.forEach(item => {
                const categoryName = item.category || 'Annet';
                if (categoryName !== currentCategory) {
                    currentCategory = categoryName;
                    const catLi = document.createElement('li');
                    catLi.className = 'category-header';
                    catLi.textContent = categoryName;
                    ul.appendChild(catLi);
                }
                const li = document.createElement('li');
                li.className = 'grocerie-item';

                // Create accessible toggle switch for completed state
                const switchLabel = document.createElement('label');
                switchLabel.className = 'switch';
                const completedCheckbox = document.createElement('input');
                completedCheckbox.type = 'checkbox';
                completedCheckbox.className = 'completed-checkbox';
                completedCheckbox.checked = !!item.completed;
                completedCheckbox.setAttribute('aria-label', `Mark ${item.name} completed`);
                completedCheckbox.addEventListener('change', () => toggleCompleted(item.name, completedCheckbox.checked, grocerieList));
                const sliderSpan = document.createElement('span');
                sliderSpan.className = 'slider';
                switchLabel.appendChild(completedCheckbox);
                switchLabel.appendChild(sliderSpan);

                // reflect completed visually on the item container
                if (item.completed) li.classList.add('completed');

                // add category class based on the category name (safe CSS class)
                const categoryClass = 'category-' + categoryName.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                li.classList.add(categoryClass);

                // create inner container for the item — background will be per-category
                const inner = document.createElement('div');
                inner.className = 'grocerie-inner';
                // set background color from saved category colors (solid, no gradient or transparency)
                const bgColor = getCategoryColor(categoryName) || '#ffffff';
                inner.style.backgroundColor = bgColor;
                inner.style.backgroundImage = 'none';

                // create the name box (white rounded)
                const nameSpan = document.createElement('span');
                nameSpan.className = 'grocerie-name';
                nameSpan.textContent = item.name;
                const nameBox = document.createElement('div');
                nameBox.className = 'grocerie-name-box';
                nameBox.appendChild(nameSpan);

                // create the controls box (qty + delete) as a white rounded group
                const controls = document.createElement('div');
                controls.className = 'grocerie-controls';

                const qtySpan = document.createElement('span');
                qtySpan.className = 'grocerie-qty';
                qtySpan.textContent = `${item.quantity} ${item.massurment}`;

                // Importance star button for this item
                console.log(item.importance);
                let importanceBtn = document.createElement('div'); // placeholder
                if (item.importance == true) {
                    //importanceBtn.type = 'button';
                    //importanceBtn = document.createElement('button');
                    importanceBtn.className = 'importance-star';
                    importanceBtn.visibility = 'visible';
                    const isImportant = !!item.importance;
                    importanceBtn.setAttribute('aria-label', `${isImportant ? 'Unmark' : 'Mark'} ${item.name} as important`);
                    importanceBtn.setAttribute('aria-pressed', isImportant ? 'true' : 'false');
                    importanceBtn.innerHTML = `
                        <svg viewBox="0 0 24 24" aria-hidden="true" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                        </svg>`;
                    if (isImportant) importanceBtn.classList.add('active');
                    //importanceBtn.addEventListener('click', (e) => { e.stopPropagation(); const newVal = isImportant ? 0 : 1; toggleImportance(item.name, newVal, grocerieList); });
                }
                
                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'delete-btn';
                deleteBtn.setAttribute('aria-label', `Delete ${item.name}`);
                deleteBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <polyline points="3 6 5 6 21 6" />
                        <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" />
                        <path d="M10 11v6" />
                        <path d="M14 11v6" />
                    </svg>`;
                
                // Click handler to request deletion (prevent event bubbling so parent handlers don't intercept the click)
                deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); handleDeleteGrocerie(item.name, grocerieList); });

                controls.appendChild(qtySpan);
                controls.appendChild(importanceBtn);
                controls.appendChild(deleteBtn);

                const controlsBox = document.createElement('div');
                controlsBox.className = 'grocerie-controls-box';
                controlsBox.appendChild(controls);

                // add toggle switch and boxes into the inner container
                inner.appendChild(switchLabel);
                inner.appendChild(nameBox);
                inner.appendChild(controlsBox);

                li.appendChild(inner);

                ul.appendChild(li);

                // Reset input controls
                document.getElementById('grocerie').value = '';
                document.getElementById('quantity').value = '';
                document.getElementById('massurmentChoiceForGroceries').value = 'stk';
            });
        }

        async function handleDeleteGrocerie(name, grocerieList){
            try {
                const res = await fetch('/api/grocerieList', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                const json = await res.json();
                if (json.grocerieList && Array.isArray(json.grocerieList)) {
                    renderGroceries(json.grocerieList);
                    return;
                }
                // Fallback: remove locally if server didn't return list
                grocerieList.forEach(g => {
                    if (name === g.name){
                        grocerieList.splice(grocerieList.indexOf(g), 1);
                        renderGroceries(grocerieList);
                        console.log("delete", name)
                    }
                })
            } catch (err) {
                console.error('Failed to delete grocerie on server', err);
            }
        }

        // Toggle completed state for a grocerie and update server
        async function toggleCompleted(name, completed, grocerieList) {
            try {
                const res = await fetch('/api/grocerieList', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, completed })
                });
                const json = await res.json();
                if (json.grocerieList && Array.isArray(json.grocerieList)) {
                    renderGroceries(json.grocerieList);
                    return;
                }
                // Fallback: update locally and re-render
                grocerieList.forEach(g => {
                    if (g.name === name) g.completed = completed;
                });
                renderGroceries(grocerieList);
            } catch (err) {
                console.error('Failed to update completed state on server', err);
            }
        }

        // Toggle importance for a grocerie and update server
        async function toggleImportance(name, importens, grocerieList) {
            try {
                const res = await fetch('/api/grocerieList', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, importens })
                });
                const json = await res.json();
                if (json.grocerieList && Array.isArray(json.grocerieList)) {
                    renderGroceries(json.grocerieList);
                    return;
                }
                // Fallback: update locally and re-render
                grocerieList.forEach(g => { if (g.name === name) g.importens = importens; });
                renderGroceries(grocerieList);
            } catch (err) {
                console.error('Failed to update importance on server', err);
            }
        }
    </script>

    <div id="groceriesList">
        <h2>
            <svg class="h2-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <path d="M4 6h16M4 12h10M4 18h16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"></path>
            </svg>
            Handleliste:
        </h2>
        <ul id="groceriesUl"></ul>
    </div>

    <button id="doneButton" onclick="finishShopping()">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        Ferdig
    </button>

    <div id="finishShoppingModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Registrer handleturen</h2>
            <form id="finishShoppingForm">
                <div class="form-group">
                    <label for="shopName">Butikk:</label>
                    <input type="text" id="shopName" name="shopName" placeholder="F.eks. Rema 1000" required>
                </div>
                <div class="form-group">
                    <label for="shopCost">Kostnad (kr):</label>
                    <input type="number" id="shopCost" name="shopCost" placeholder="F.eks. 450.50" step="0.01" min="0" required>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="btn-submit">Lagre</button>
                    <button type="button" class="btn-cancel" onclick="cancelFinishShopping()">Avbryt</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function finishShopping() {
            // Show the modal dialog
            const modal = document.getElementById('finishShoppingModal');
            modal.style.display = 'flex';
        }

        function cancelFinishShopping() {
            const modal = document.getElementById('finishShoppingModal');
            modal.style.display = 'none';
            // Reset form
            document.getElementById('finishShoppingForm').reset();
        }

        async function processFinishShopping(shopName, shopCost) {
            try {
                // Fetch the current grocery list from the server
                const res = await fetch('/api/grocerieList');
                const json = await res.json();
                
                if (!json.grocerieList || !Array.isArray(json.grocerieList)) {
                    alert('Could not retrieve grocery list');
                    return;
                }
                
                // Filter completed items and create an object
                const completedItems = json.grocerieList.filter(item => item.completed);
                
                const completedObject = {
                    timestamp: new Date().toISOString(),
                    shopName: shopName,
                    cost: parseFloat(shopCost),
                    itemCount: completedItems.length,
                    items: completedItems.map(item => ({
                        name: item.name,
                        quantity: item.quantity,
                        massurment: item.massurment,
                        category: item.category,
                        importance: item.importance
                    }))
                };
                
                console.log('Completed shopping items:', completedObject);
                
                // POST the completed list to the backend
                try {
                    const postRes = await fetch('/api/handleliste', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(completedObject)
                    });
                    const postJson = await postRes.json();
                    if (postJson.ok) {
                        console.log('Completed list saved to backend with ID:', postJson.savedListId);
                    } else {
                        console.warn('Failed to save to backend:', postJson.error);
                    }
                } catch(err) {
                    console.error('Error posting to backend:', err);
                }
                
                // Add completed items to the ingredients list on the index page
                try {
                    completedItems.forEach(item => {
                        const ingredientRes = fetch('/api/ingredients', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                name: item.name, 
                                quantity: item.quantity, 
                                massurment: item.massurment,
                                category: item.category || 'Annet'
                            })
                        });
                    });
                    console.log('Completed items added to ingredients list');
                } catch(err) {
                    console.error('Error adding completed items to ingredients list:', err);
                }
                
                // Clear completed items from the backend and frontend
                try {
                    const deleteRes = await fetch('/api/grocerieList/completed', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const deleteJson = await deleteRes.json();
                    if (deleteJson.ok) {
                        console.log(`Removed ${deleteJson.removedCount} completed items from list`);
                        // Re-render the list to show remaining items
                        renderGroceries(deleteJson.grocerieList);
                    } else {
                        console.warn('Failed to clear completed items:', deleteJson.error);
                    }
                } catch(err) {
                    console.error('Error clearing completed items:', err);
                }
                
                // Save to localStorage for persistence
                try {
                    localStorage.setItem('lastCompletedShopping', JSON.stringify(completedObject));
                } catch(e) {
                    console.warn('Could not save to localStorage', e);
                }
                
                // Close modal
                cancelFinishShopping();
            } catch (err) {
                console.error('Error processing completed items:', err);
                alert('En feil oppstod under behandling av handlelisten');
            }
        }

        // Handle form submission
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('finishShoppingForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const shopName = document.getElementById('shopName').value.trim();
                    const shopCost = document.getElementById('shopCost').value.trim();
                    
                    if (!shopName || !shopCost) {
                        alert('Vennligst fyll inn alle feltene');
                        return;
                    }
                    
                    processFinishShopping(shopName, shopCost);
                });
            }
        });
    </script>

</body>
</html>