<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="savedHandleliste.css">
</head>
<body>
    <div id="menuBoxTop">
        <button onclick="location.href='index.html'">
            Gå til kjøleskap
        </button>
        <button onclick="location.href='handleliste.html'">
            Gå til handleliste arkiv
        </button>
    </div>
    <h1>Handleliste Arkiv</h1>
    
    <div id="savedListsContainer">
        <!-- Saved shopping lists will be displayed here -->
    </div>

    <script>
        // Fetch and display all saved shopping lists when the page loads
        async function loadSavedShoppingLists() {
            try {
                const response = await fetch('/api/handleliste');
                const data = await response.json();
                
                if (!data.ok || !Array.isArray(data.SavedGrocerieList)) {
                    console.error('Failed to fetch saved shopping lists');
                    displayNoLists();
                    return;
                }
                
                const savedLists = data.SavedGrocerieList;
                
                if (savedLists.length === 0) {
                    displayNoLists();
                    return;
                }
                
                // Sort by shop name first, then by timestamp (newest first)
                const sortedLists = savedLists.sort((a, b) => {
                    // First sort by shop name (alphabetically)
                    const shopComparison = (a.shopName || '').localeCompare(b.shopName || '');
                    if (shopComparison !== 0) {
                        return shopComparison;
                    }
                    // Then sort by timestamp (newest first)
                    return new Date(b.timestamp) - new Date(a.timestamp);
                });
                
                displayLists(sortedLists);
            } catch (error) {
                console.error('Error loading saved shopping lists:', error);
                displayNoLists();
            }
        }
        
        function displayNoLists() {
            const container = document.getElementById('savedListsContainer');
            container.innerHTML = '<p>Ingen lagrede handlelister ennå.</p>';
        }
        
        function displayLists(lists) {
            const container = document.getElementById('savedListsContainer');
            container.innerHTML = '';
            
            // Group by shop name for better organization
            const groupedByShop = {};
            lists.forEach(list => {
                const shop = list.shopName || 'Ukjent butikk';
                if (!groupedByShop[shop]) {
                    groupedByShop[shop] = [];
                }
                groupedByShop[shop].push(list);
            });
            
            // Display each shop's lists
            Object.keys(groupedByShop).sort().forEach(shopName => {
                const shopDiv = document.createElement('div');
                shopDiv.className = 'shop-group';
                
                const shopHeader = document.createElement('h2');
                shopHeader.textContent = shopName;
                shopDiv.appendChild(shopHeader);
                
                groupedByShop[shopName].forEach((list, index) => {
                    const listId = `list-${shopName.replace(/\s+/g, '-')}-${index}`;
                    
                    const listDiv = document.createElement('div');
                    listDiv.className = 'shopping-list-item';
                    
                    const date = new Date(list.timestamp);
                    const dateFormatted = date.toLocaleDateString('no-NO', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    // Create the summary header (always visible)
                    const summaryDiv = document.createElement('div');
                    summaryDiv.className = 'list-summary';
                    summaryDiv.innerHTML = `
                        <div class="summary-content">
                            <span class="shop-name"><strong>${shopName}</strong></span>
                            <span class="summary-date">${dateFormatted}</span>
                        </div>
                        <button class="expand-btn" onclick="toggleListDetails('${listId}')">▼</button>
                    `;
                    
                    listDiv.appendChild(summaryDiv);
                    
                    // Create the expandable details section
                    const detailsDiv = document.createElement('div');
                    detailsDiv.id = listId;
                    detailsDiv.className = 'list-details';
                    detailsDiv.style.display = 'none';
                    
                    detailsDiv.innerHTML = `
                        <div class="details-header">
                            <span class="cost">Kostnad: ${list.cost ? list.cost.toFixed(2) : '0.00'} kr</span>
                            <span class="item-count">${list.itemCount || list.items.length} varer</span>
                        </div>
                        <div class="list-items">
                            ${list.items.map(item => `
                                <div class="item" style="background-color: ${getCategoryColor(item.category)}">
                                    <span class="item-name">${item.name}</span>
                                    <span class="item-quantity">${item.quantity} ${item.massurment}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    listDiv.appendChild(detailsDiv);
                    
                    shopDiv.appendChild(listDiv);
                });
                
                container.appendChild(shopDiv);
            });
        }
        
        function toggleListDetails(listId) {
            const detailsDiv = document.getElementById(listId);
            const btn = event.target;
            
            if (detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
                btn.textContent = '▲';
            } else {
                detailsDiv.style.display = 'none';
                btn.textContent = '▼';
            }
        }
        
        // Category color map (same as in handleliste.html)
        const defaultCategoryColors = {
            'Annet': 'rgb(255,255,255)',
            'Frukt og grønt': 'rgb(231,249,231)',
            'Kjøtt og fisk': 'rgb(255,236,236)',
            'Meieri': 'rgb(255,247,217)',
            'Drikke': 'rgb(231,245,255)',
            'Bakevarer': 'rgb(255,241,224)',
            'Frostvarer': 'rgb(238,247,255)',
            'Husholdning': 'rgb(247,247,251)',
            'Helse & vellvære': 'rgb(255,176,197)',
            'Kos': 'rgb(255,240,247)'
        };
        
        function getCategoryColor(category) {
            return defaultCategoryColors[category] || 'rgb(255,255,255)';
        }
        
        // Load the saved shopping lists when the page loads
        window.addEventListener('DOMContentLoaded', loadSavedShoppingLists);
    </script>
</body>
</html>