<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <div id="menuBoxTop">
        <button onclick="location.href='handleliste.html'">
            Gå til handlesliste
        </button>
        <button onclick="location.href='savedhandleliste.html'">
            Gå til handleliste arkiv
        </button>
        <button onclick="location.href='oppskrifter.html'">
            Gå til oppskrifter
        </button>
    </div>


    <div id="headerDiv">
            <h1 id="header1">Hva har vi i kjøleskapet og hjem?</h1>
        </div>
    <div id="inputBox">
        
        <div>
            <input id="ingredient" type="text" pattern="[A-Za-z ]+" name="ingredient" placeholder="Enter ingredient">
            <div class="unit-controls">
                <label for="massurmentChoice">
                    <select name="massurment" id="massurmentChoice">
                        <option value="stk">Stk</option>
                        <option value="Gram">Gram</option>
                        <option value="Kilogram">Kilogram</option>
                        <option value="Liter">Liter</option>
                        <option value="Milliliter">Milliliter</option>
                    </select>
                </label>
                <input id="quantity" type="text" inputmode="decimal" step="any" name="quantity" placeholder="Enter quantity (e.g., 1,5)">
                
                <label for="categoryChoice">
                    <select name="category" id="categoryChoice">
                        <option value="Annet">Annet</option>
                        <option value="Frukt og grønt">Frukt og grønt</option>
                        <option value="Kjøtt og fisk">Kjøtt og fisk</option>
                        <option value="Meieri">Meieri</option>
                        <option value="Drikke">Drikke</option>
                        <option value="Bakevarer">Bakevarer</option>
                        <option value="Frostvarer">Frostvarer</option>
                        <option value="Husholdning">Husholdning</option>
                        <option value="Helse & vellvære">Helse & vellvære</option>
                        <option value="Kos">Kos</option>
                    </select>
                </label>
            </div>
            <button id="addIngridientButton">
                Legg til ingredients
            </button>
            
        </div>
    </div>


        <script>
            function capitalizeFirstLetter(str) {
                return str.charAt(0).toUpperCase() + str.slice(1);
            }

            const ingredientsNames = [];
            // Attach button click to client-side function
            document.getElementById('addIngridientButton').addEventListener('click', addIngridient);

            // Load initial ingredients from server and render them
            (async function init() {
                try {
                    const res = await fetch('/api/ingredients');
                    const json = await res.json();
                    if (json.ingredients && Array.isArray(json.ingredients)) {
                        renderIngredients(json.ingredients);
                        json.ingredients.forEach(i => ingredientsNames.push(i.name));
                    }
                } catch (e) {
                    console.warn('Could not load initial ingredients', e);
                }
            })();

            async function addIngridient() {
                // Get values from input fields, remove whitespace
                let name = document.getElementById('ingredient').value.trim();
                const qtyStr = document.getElementById('quantity').value.trim();
                const massurment = document.getElementById('massurmentChoice').value;
                const category = document.getElementById('categoryChoice').value;
                // Capitalize first letter of name
                name = capitalizeFirstLetter(name);

                //Checks for empty fields
                if (name === "" || qtyStr === "") { alert('Please enter name and quantity'); return; }

                // Normalize comma to dot so parseFloat works with both '1.5' and '1,5', then convert to float
                const qty = parseFloat(qtyStr.replace(',', '.'));
                if (Number.isNaN(qty) || qty <= 0) { alert('Please enter a valid quantity greater than 0'); return; }

                // Send POST request to backend
                const res = await fetch('/api/ingredients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, quantity: qty , massurment, category })
                });
                const json = await res.json();

                // If server returns the full list, re-render it and update names index
                if (json.ingredients && Array.isArray(json.ingredients)) {
                    renderIngredients(json.ingredients);
                    ingredientsNames.length = 0;
                    json.ingredients.forEach(i => ingredientsNames.push(i.name));
                    return;
                }

                // Fallback for older response shape (single ingredient)
                if (ingredientsNames.includes(name)) {
                    // Update quantity locally if needed
                    json.ingredient.quantity += qty;
                    printIngredient(json.ingredient);
                    console.log(json.ingredient)
                    return;
                } else {
                    // Add ingredient name to list of existing ingredients if not existing already
                    ingredientsNames.push(name);
                }

                try {
                    printIngredient(json.ingredient);
                } catch (e) {
                    alert('Failed to add ingredient');
                }
            }

            // Function to render the full list of ingredients
            function renderIngredients(ingredients) {
                const ul = document.getElementById('ingredientsUl');
                // Clear existing list
                ul.innerHTML = '';
                
                // Define category order
                const categoryOrder = [
                    'Frukt og grønt',
                    'Kjøtt og fisk',
                    'Meieri',
                    'Drikke',
                    'Bakevarer',
                    'Frostvarer',
                    'Husholdning',
                    'Helse & vellvære',
                    'Kos',
                    'Annet'
                ];
                
                // Group ingredients by category
                const groupedIngredients = {};
                categoryOrder.forEach(cat => { groupedIngredients[cat] = []; });
                
                ingredients.forEach(ingredient => {
                    const cat = ingredient.category || 'Annet';
                    if (!groupedIngredients[cat]) groupedIngredients[cat] = [];
                    groupedIngredients[cat].push(ingredient);
                });
                
                // Render each category group
                categoryOrder.forEach(category => {
                    const items = groupedIngredients[category];
                    if (items.length === 0) return;
                    
                    // Add category header
                    const categoryHeader = document.createElement('li');
                    categoryHeader.className = 'category-header';
                    categoryHeader.textContent = category;
                    ul.appendChild(categoryHeader);
                    
                    // Add ingredients in this category
                    items.forEach(ingredient => {
                        const li = document.createElement('li');
                        li.className = 'ingredient-item';
                        li.setAttribute('data-category', category);

                        // Add category class based on the category name (safe CSS class)
                        const categoryClass = 'category-' + category.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                        li.classList.add(categoryClass);

                        // Create inner container for the item — background will be per-category
                        const inner = document.createElement('div');
                        inner.className = 'ingredient-inner';

                        // Create the name box (white rounded)
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'ingredient-name';
                        nameSpan.textContent = ingredient.name;
                        const nameBox = document.createElement('div');
                        nameBox.className = 'ingredient-name-box';
                        nameBox.appendChild(nameSpan);

                        // Create the controls box (qty + delete) as a white rounded group
                        const controls = document.createElement('div');
                        controls.className = 'ingredient-controls';

                        const qtySpan = document.createElement('span');
                        qtySpan.className = 'ingredient-qty';
                        qtySpan.textContent = `${ingredient.quantity} ${ingredient.massurment}`;

                        const deleteBtn = document.createElement('button');
                        deleteBtn.type = 'button';
                        deleteBtn.className = 'delete-btn';
                        deleteBtn.setAttribute('aria-label', `Delete ${ingredient.name}`);
                        deleteBtn.innerHTML = `
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <polyline points="3 6 5 6 21 6" />
                                <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" />
                                <path d="M10 11v6" />
                                <path d="M14 11v6" />
                            </svg>`;

                        // Click handler to request deletion
                        deleteBtn.addEventListener('click', () => handleDeleteIngredient(ingredient.name,ingredients));

                        controls.appendChild(qtySpan);
                        controls.appendChild(deleteBtn);

                        const controlsBox = document.createElement('div');
                        controlsBox.className = 'ingredient-controls-box';
                        controlsBox.appendChild(controls);

                        // Add boxes into the inner container
                        inner.appendChild(nameBox);
                        inner.appendChild(controlsBox);

                        li.appendChild(inner);

                        ul.appendChild(li);

                        });
                    });
                };
                
                // Reset form fields
                document.getElementById('ingredient').value = '';
                document.getElementById('quantity').value = '';
                document.getElementById('massurmentChoice').value = 'stk';
                document.getElementById('categoryChoice').value = 'Annet';
            
            async function handleDeleteIngredient(name, ingredients){
                try {
                    const res = await fetch('/api/ingredients', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name })
                    });
                    const json = await res.json();
                    if (json.ingredients && Array.isArray(json.ingredients)) {
                        renderIngredients(json.ingredients);
                        return;
                    }
                    // Fallback: remove locally if server didn't return list
                    ingredients.forEach(ingredient => {
                        if (name === ingredient.name){
                            ingredients.splice(ingredients.indexOf(ingredient), 1);
                            renderIngredients(ingredients);
                            console.log("delete", name)
                        }
                    })
                } catch (err) {
                    console.error('Failed to delete ingredient on server', err);
                }
            }

            // Helper to replace the full ingredients list on the server
            async function updateIngredientsOnServer(ingredients) {
                try {
                    const res = await fetch('/api/ingredients', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ingredients })
                    });
                    const json = await res.json();
                    if (json.ingredients && Array.isArray(json.ingredients)) {
                        renderIngredients(json.ingredients);
                    }
                } catch (err) {
                    console.error('Failed to update ingredients on server', err);
                }
            }

            document.getElementById("ingredient").addEventListener("input", function () {
                this.value = this.value.replace(/[^\p{L} ]/gu, "");
            });
            
            document.getElementById("quantity").addEventListener("input", function () {
                // Allow digits and one decimal separator (comma or dot). Keep the first separator entered and remove any extra separators.
                let val = this.value.replace(/[^0-9.,]/g, "");
                const firstSepMatch = val.match(/[.,]/);
                if (firstSepMatch) {
                    const sep = firstSepMatch[0];
                    const parts = val.split(/[.,]/);
                    val = parts.shift() + sep + parts.join('');
                }
                this.value = val;
            });
            
        </script>


        <div id="ingredientsList">
            <h2>
                <!-- inline SVG icon (ingredients/list) for the badge; uses currentColor so it inherits the white text color -->
                <svg class="h2-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                    <path d="M4 6h16M4 12h10M4 18h16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"></path>
                </svg>
                ingredientser:
            </h2>
            <ul id="ingredientsUl">
                
            </ul>

        </div>
      
</body>
</html>